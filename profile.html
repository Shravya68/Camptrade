<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - CampTrade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; }
        .item-card-image {
            aspect-ratio: 4 / 3;
            object-fit: cover;
        }
        .chat-list-item.active { background-color: #eff6ff; }
    </style>
    
    <!-- Load verification libraries -->
    <script src="js/verification.js"></script>
    <script src="js/firebase-transactions.js"></script>
    <script src="js/firebase-transactions-fallback.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-blue-600">CampTrade</a>
            <div class="hidden md:flex items-center space-x-6">
                <a href="index.html" class="text-gray-600 hover:text-blue-600">Browse</a>
                <a href="sell.html" class="text-gray-600 hover:text-blue-600">Sell</a>
                <a href="rent.html" class="text-gray-600 hover:text-blue-600">Rent</a>
                <a href="donate.html" class="text-gray-600 hover:text-blue-600">Donate</a>
                <a href="wishlist.html" class="text-gray-600 hover:text-blue-600">Wishlist</a>
            </div>
            <div id="user-menu" class="hidden items-center space-x-4">
                 <a href="profile.html" id="profileLink" class="font-semibold text-blue-600">My Profile</a>
                 <button id="logoutBtn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">Log Out</button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <!-- Left Panel -->
            <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-lg h-fit">
                <h2 class="text-2xl font-bold mb-4">My Messages</h2>
                <div id="chat-list" class="space-y-2">
                    <p class="text-gray-500 text-sm">No active chats.</p>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="md:col-span-3">
                <!-- Chat Window (hidden by default) -->
                <div id="chat-window" class="hidden bg-white p-6 rounded-lg shadow-lg h-[80vh] flex-col">
                     <div class="flex justify-between items-center pb-4 border-b">
                        <h3 class="text-xl font-bold text-gray-800">Chat with <span id="chatWithUser"></span></h3>
                        <button id="backToProfileBtn" class="text-sm text-blue-600 hover:underline">Back to Profile</button>
                    </div>
                    <div id="chatMessages" class="flex-grow p-4 overflow-y-auto bg-gray-50 my-4 rounded-lg"></div>
                    <form id="chatForm" class="p-4 border-t flex space-x-2">
                        <input type="text" id="chatInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Type your message..." required>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Send</button>
                    </form>
                </div>

                <!-- Profile Info -->
                <div id="profile-info">
                    <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                        <h2 class="text-3xl font-bold mb-6">My Profile</h2>
                        <div class="text-center mb-8 p-6 bg-gray-50 rounded-lg">
                            <h3 id="profileName" class="text-4xl font-bold">Loading...</h3>
                            <p id="profileEmail" class="text-gray-600 mt-1"></p>
                        </div>
                        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg text-center">
                            <p class="font-bold text-lg">Reward Points</p>
                            <p id="profilePoints" class="text-5xl font-bold mt-2">0</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                        <h2 class="text-2xl font-bold mb-4">My Transactions</h2>
                        <div id="transactions-container">
                            <p class="text-gray-500">No pending transactions.</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                        <h4 class="text-2xl font-bold mb-4">My Wishlist</h4>
                        <form id="wishlistForm" class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-semibold mb-2">Add a New Wish</h5>
                            <div class="flex flex-col md:flex-row gap-4">
                                <input type="text" id="wishItemName" placeholder="What item are you looking for?" class="w-full px-4 py-2 border rounded-lg" required>
                                <input type="text" id="wishDescription" placeholder="Any specific details? (optional)" class="w-full px-4 py-2 border rounded-lg">
                                <button type="submit" class="bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-blue-700">Add Wish</button>
                            </div>
                        </form>
                        <div id="myWishes" class="space-y-2">
                            <p class="text-gray-500">You have not added any wishes yet.</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h4 class="text-2xl font-bold mb-4">My Listings</h4>
                        <div id="myListings" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <p class="text-gray-500">Loading your listings...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <p id="alertMessage" class="text-lg mb-4"></p>
            <button id="closeAlertModal" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg">OK</button>
        </div>
    </div>
    
    <script type="module">
        const firebaseConfig = {
          apiKey: "AIzaSyCqtPN9O7vnxltylayJzoXY8n_5A9T2D4k",
          authDomain: "camptrade-1f932.firebaseapp.com",
          projectId: "camptrade-1f932",
          storageBucket: "camptrade-1f932.appspot.com",
          messagingSenderId: "990486537343",
          appId: "1:990486537343:web:46ba92fe33690d7ebd0b4a"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, get, set, push, serverTimestamp, query, orderByChild, equalTo, remove, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getFunctions } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";
        
        const app = initializeApp(firebaseConfig);
        const functions = getFunctions(app);
        
        // Initialize transaction manager and verification system (using fallback for now)
        console.log('Initializing transaction manager...');
        const transactionManager = new FirebaseTransactionsFallback(db);
        const verificationSystem = new TransactionVerification();
        console.log('Systems ready');
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        const chatWindow = document.getElementById('chat-window');
        const profileInfo = document.getElementById('profile-info');
        const wishlistForm = document.getElementById('wishlistForm');
        let currentChatListener = null;
        let currentChatId = null;

        const showAlert = (message) => {
            const alertModal = document.getElementById('alertModal');
            const alertMessage = document.getElementById('alertMessage');
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        };
        document.getElementById('closeAlertModal').addEventListener('click', () => {
            document.getElementById('alertModal').classList.add('hidden');
        });

        const showProfileView = () => {
            chatWindow.classList.add('hidden');
            profileInfo.classList.remove('hidden');
            if (currentChatListener) currentChatListener();
            document.querySelectorAll('.chat-list-item').forEach(item => item.classList.remove('active'));
        };
        
        document.getElementById('backToProfileBtn').addEventListener('click', showProfileView);

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.assign('login.html');
            } else {
                document.getElementById('user-menu').classList.remove('hidden');
                document.getElementById('user-menu').classList.add('flex');
                document.getElementById('profileLink').textContent = user.email;
                loadProfileData(user);
                loadMyListings(user);
                loadChatList(user);
                loadMyWishes(user);
                loadTransactions(user);
                
                const params = new URLSearchParams(window.location.search);
                const startChatWithId = params.get('startChatWith');
                const startChatWithEmail = params.get('email');
                if (startChatWithId && startChatWithEmail) {
                    const chatId = [user.uid, startChatWithId].sort().join('_');
                    const chatMetaRef = ref(db, `chats/${chatId}/_meta`);
                    set(chatMetaRef, { [user.uid]: user.email, [startChatWithId]: startChatWithEmail });
                    set(ref(db, `user-chats/${user.uid}/${chatId}`), true);
                    set(ref(db, `user-chats/${startChatWithId}/${chatId}`), true);
                    
                    openChat(startChatWithId, startChatWithEmail);
                    window.history.replaceState({}, document.title, "profile.html");
                }
            }
        });

        const loadProfileData = (user) => {
             const userRef = ref(db, 'users/' + user.uid);
            onValue(userRef, (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('profileName').textContent = userData.name;
                    document.getElementById('profileEmail').textContent = userData.email;
                    document.getElementById('profilePoints').textContent = userData.rewardPoints || 0;
                }
            });
        };
        
        const loadMyListings = async (user) => {
            const myListingsContainer = document.getElementById('myListings');
            myListingsContainer.innerHTML = '';
            const sellQuery = query(ref(db, 'items'), orderByChild('sellerId'), equalTo(user.uid));
            const rentQuery = query(ref(db, 'rent-items'), orderByChild('listerId'), equalTo(user.uid));
            const donateQuery = query(ref(db, 'donation-items'), orderByChild('donatorId'), equalTo(user.uid));
            const [sellSnapshot, rentSnapshot, donateSnapshot] = await Promise.all([
                get(sellQuery), get(rentQuery), get(donateQuery)
            ]);
            const allMyItems = [];
            sellSnapshot.forEach(child => allMyItems.push({ id: child.key, ...child.val(), type: 'sell'}));
            rentSnapshot.forEach(child => allMyItems.push({ id: child.key, ...child.val(), type: 'rent'}));
            donateSnapshot.forEach(child => allMyItems.push({ id: child.key, ...child.val(), type: 'donate'}));
            if (allMyItems.length > 0) {
                 allMyItems.sort((a,b) => b.createdAt - a.createdAt).forEach(item => {
                     let priceHTML = '';
                     if (item.type === 'donate') priceHTML = `<p class="font-bold text-green-600 text-sm mt-1">Donation</p>`;
                     else if (item.type === 'rent') priceHTML = `<p class="font-bold text-blue-600 text-sm mt-1">₹${item.price} / day</p>`;
                     else priceHTML = `<p class="font-bold text-blue-600 text-sm mt-1">₹${item.price}</p>`;
                    const itemCard = `
                        <a href="item.html?id=${item.id}&type=${item.type}" class="block bg-gray-50 rounded-lg p-2 shadow">
                            <img src="${item.imageUrl}" class="w-full h-24 item-card-image rounded">
                            <h4 class="font-semibold truncate mt-2 text-sm">${item.title}</h4>
                            ${priceHTML}
                        </a>
                    `;
                    myListingsContainer.innerHTML += itemCard;
                 });
            } else {
                myListingsContainer.innerHTML = '<p class="text-gray-500 col-span-full">You have not listed any items yet.</p>';
            }
        };

        const loadChatList = (user) => {
            const chatListContainer = document.getElementById('chat-list');
            const myChatsRef = ref(db, `user-chats/${user.uid}`);
            onValue(myChatsRef, (snapshot) => {
                chatListContainer.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const chatId = childSnapshot.key;
                        const chatMetaRef = ref(db, `chats/${chatId}/_meta`);
                        get(chatMetaRef).then((metaSnapshot) => {
                            if (metaSnapshot.exists()) {
                                const meta = metaSnapshot.val();
                                const otherUserId = Object.keys(meta).find(id => id !== user.uid);
                                const otherUserEmail = meta[otherUserId];
                                const chatListItem = document.createElement('div');
                                chatListItem.className = "chat-list-item p-2 rounded-lg cursor-pointer hover:bg-gray-100";
                                chatListItem.dataset.chatId = otherUserId;
                                chatListItem.textContent = otherUserEmail;
                                chatListItem.onclick = () => openChat(otherUserId, otherUserEmail);
                                chatListContainer.appendChild(chatListItem);
                            }
                        });
                    });
                } else {
                    chatListContainer.innerHTML = '<p class="text-gray-500 text-sm">No active chats.</p>';
                }
            });
        };

        const openChat = (receiverId, receiverEmail) => {
            profileInfo.classList.add('hidden');
            chatWindow.classList.remove('hidden');
            document.querySelectorAll('.chat-list-item').forEach(item => {
                item.dataset.chatId === receiverId ? item.classList.add('active') : item.classList.remove('active');
            });
            currentChatId = [auth.currentUser.uid, receiverId].sort().join('_');
            document.getElementById('chatWithUser').textContent = receiverEmail;
            
            const messagesRef = ref(db, 'chats/' + currentChatId);
            if (currentChatListener) currentChatListener();
            currentChatListener = onValue(messagesRef, (snapshot) => {
                const chatMessagesContainer = document.getElementById('chatMessages');
                chatMessagesContainer.innerHTML = '';
                const messages = snapshot.val();
                if (messages) {
                    Object.values(messages).filter(msg => typeof msg === 'object').sort((a, b) => a.createdAt - b.createdAt).forEach(message => {
                        appendMessage(message.text, message.senderId === auth.currentUser.uid);
                    });
                }
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            });
        };

        const appendMessage = (text, isSender) => {
            const chatMessagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.textContent = text;
            messageDiv.className = `p-3 my-2 rounded-lg max-w-xs ${isSender ? 'bg-blue-500 text-white ml-auto' : 'bg-gray-200 text-gray-800'}`;
            chatMessagesContainer.appendChild(messageDiv);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        };

        document.getElementById('chatForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const chatInput = document.getElementById('chatInput');
            const messageText = chatInput.value.trim();
            const currentUser = auth.currentUser;
            if (messageText && currentUser && currentChatId) {
                appendMessage(messageText, true);
                const messagesRef = ref(db, 'chats/' + currentChatId);
                const newMessageRef = push(messagesRef);
                set(newMessageRef, {
                    text: messageText,
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                chatInput.value = '';
            }
        });

        const loadMyWishes = (user) => {
            const myWishesContainer = document.getElementById('myWishes');
            const wishesQuery = query(ref(db, 'wishes'), orderByChild('wisherId'), equalTo(user.uid));
            onValue(wishesQuery, (snapshot) => {
                myWishesContainer.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const wish = child.val();
                        const wishEl = document.createElement('div');
                        wishEl.className = "bg-gray-100 p-3 rounded-lg flex justify-between items-center text-sm";
                        wishEl.innerHTML = `
                            <div>
                                <p class="font-semibold">${wish.itemName}</p>
                                <p class="text-gray-500 text-xs">${wish.description || ''}</p>
                            </div>
                            <button data-wish-id="${child.key}" class="delete-wish-btn text-xs text-red-500 hover:underline">Delete</button>
                        `;
                        myWishesContainer.appendChild(wishEl);
                    });
                    document.querySelectorAll('.delete-wish-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const wishId = e.target.dataset.wishId;
                            if(confirm("Are you sure you want to delete this wish?")) {
                                remove(ref(db, `wishes/${wishId}`));
                            }
                        });
                    });
                } else {
                    myWishesContainer.innerHTML = '<p class="text-gray-500 text-sm">You have not added any wishes yet.</p>';
                }
            });
        };

        wishlistForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            const itemName = document.getElementById('wishItemName').value.trim();
            const description = document.getElementById('wishDescription').value.trim();
            if (user && itemName) {
                const wishesRef = ref(db, 'wishes');
                const newWishRef = push(wishesRef);
                set(newWishRef, {
                    itemName, description,
                    wisherId: user.uid, wisherEmail: user.email,
                    createdAt: serverTimestamp()
                });
                wishlistForm.reset();
            }
        });

        const loadTransactions = async (user) => {
            const transactionsContainer = document.getElementById('transactions-container');
            
            try {
                const transactions = await transactionManager.getUserTransactions(user.uid);
                transactionsContainer.innerHTML = '';
                
                if (transactions.length === 0) {
                    transactionsContainer.innerHTML = '<p class="text-gray-500">No transactions found.</p>';
                    return;
                }

                transactions.forEach(tx => {
                    const statusBadge = TransactionStatus.getStatusBadge(tx.status);
                    let cardHTML = '';
                    
                    if (tx.userRole === 'buyer') {
                        // Buyer view
                        if (tx.status === 'requested') {
                            cardHTML = `
                                <div class="bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <p><strong>Buying:</strong> ${tx.itemTitle}</p>
                                        ${statusBadge}
                                    </div>
                                    <p class="text-sm text-gray-600">Waiting for seller approval...</p>
                                    <p class="text-xs text-gray-500 mt-2">Price: ₹${tx.price}</p>
                                </div>
                            `;
                        } else if (tx.status === 'approved' || tx.status === 'exchange_pending') {
                            cardHTML = `
                                <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <p><strong>Buying:</strong> ${tx.itemTitle}</p>
                                        ${statusBadge}
                                    </div>
                                    <div class="mt-3">
                                        <p class="font-medium mb-2">Your Verification PIN:</p>
                                        <p class="text-2xl font-mono text-blue-600 tracking-widest bg-white p-2 rounded border">${tx.verificationPin}</p>
                                        <div class="mt-3" id="qr-container-${tx.id}">
                                            <p class="font-medium mb-2">QR Code:</p>
                                            <canvas id="qr-canvas-${tx.id}"></canvas>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2">Show either the PIN or QR code to the seller during exchange.</p>
                                    </div>
                                </div>
                            `;
                        } else if (tx.status === 'completed') {
                            cardHTML = `
                                <div class="bg-green-50 p-4 rounded-lg mb-4 border border-green-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <p><strong>Purchased:</strong> ${tx.itemTitle}</p>
                                        ${statusBadge}
                                    </div>
                                    <p class="text-sm text-gray-600">Transaction completed successfully!</p>
                                    <p class="text-xs text-gray-500 mt-2">You earned 10 reward points!</p>
                                </div>
                            `;
                        }
                    } else {
                        // Seller view
                        if (tx.status === 'requested') {
                            cardHTML = `
                                <div class="bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <p><strong>Selling:</strong> ${tx.itemTitle} to ${tx.buyerEmail}</p>
                                        ${statusBadge}
                                    </div>
                                    <div class="flex gap-2 mt-3">
                                        <button onclick="approveTransaction('${tx.id}')" 
                                                class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                                            Approve Transaction
                                        </button>
                                        <button onclick="rejectTransaction('${tx.id}')" 
                                                class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">
                                            Reject
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else if (tx.status === 'approved' || tx.status === 'exchange_pending') {
                            cardHTML = `
                                <div class="bg-green-50 p-4 rounded-lg mb-4 border border-green-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <p><strong>Selling:</strong> ${tx.itemTitle} to ${tx.buyerEmail}</p>
                                        ${statusBadge}
                                    </div>
                                    <div class="mt-3">
                                        <button onclick="openVerificationModal('${tx.id}', '${tx.qrCodeData}')" 
                                                class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                            Verify Exchange
                                        </button>
                                        <p class="text-xs text-gray-500 mt-2">Click to verify PIN or scan QR code from buyer</p>
                                    </div>
                                </div>
                            `;
                        } else if (tx.status === 'completed') {
                            cardHTML = `
                                <div class="bg-green-50 p-4 rounded-lg mb-4 border border-green-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <p><strong>Sold:</strong> ${tx.itemTitle} to ${tx.buyerEmail}</p>
                                        ${statusBadge}
                                    </div>
                                    <p class="text-sm text-gray-600">Transaction completed successfully!</p>
                                    <p class="text-xs text-gray-500 mt-2">You earned 15 reward points!</p>
                                </div>
                            `;
                        }
                    }
                    
                    transactionsContainer.innerHTML += cardHTML;
                });

                // Generate QR codes for buyer transactions
                transactions.forEach(tx => {
                    if (tx.userRole === 'buyer' && (tx.status === 'approved' || tx.status === 'exchange_pending')) {
                        setTimeout(() => {
                            verificationSystem.generateQRCode(tx.qrCodeData, `qr-canvas-${tx.id}`).catch(console.error);
                        }, 100);
                    }
                });

            } catch (error) {
                console.error('Error loading transactions:', error);
                transactionsContainer.innerHTML = '<p class="text-red-500">Error loading transactions.</p>';
            }
        };

        // Approve transaction (seller)
        window.approveTransaction = async (transactionId) => {
            try {
                await transactionManager.approveTransaction(transactionId);
                showAlert("Transaction approved! Buyer can now proceed with exchange.");
                // Reload transactions
                const user = auth.currentUser;
                if (user) loadTransactions(user);
            } catch (error) {
                showAlert("Error approving transaction: " + error.message);
            }
        };

        // Open verification modal (seller)
        window.openVerificationModal = (transactionId, qrData) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Verify Transaction</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="verification-ui-container"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const container = modal.querySelector('#verification-ui-container');
            const verificationUI = verificationSystem.createVerificationUI(
                transactionId, 
                qrData, 
                handleVerification
            );
            container.appendChild(verificationUI);
        };

        // Handle verification (PIN or QR)
        const handleVerification = async (transactionId, verificationCode, verificationType) => {
            try {
                const result = await transactionManager.verifyTransaction(transactionId, verificationCode, verificationType);
                
                // Close modal
                document.querySelector('.fixed.inset-0')?.remove();
                
                showAlert(`Verification successful! Transaction completed. Points awarded: Buyer +${result.buyerPointsAwarded}, Seller +${result.sellerPointsAwarded}`);
                
                // Reload transactions and profile data
                const user = auth.currentUser;
                if (user) {
                    loadTransactions(user);
                    loadProfileData(user);
                }
            } catch (error) {
                verificationSystem.showStatus(
                    document.querySelector('#verification-status'),
                    error.message,
                    'error'
                );
            }
        };

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
    </script>
</body>
</html>